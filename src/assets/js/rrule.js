/*!
 * rrule.js - Library for working with recurrence rules for calendar dates.
 * https://github.com/jkbrzt/rrule
 *
 * Copyright 2010, Jakub Roztocil and Lars Schoning
 * Licenced under the BSD licence.
 * https://github.com/jkbrzt/rrule/blob/master/LICENCE
 *
 * Based on:
 * python-dateutil - Extensions to the standard Python datetime module.
 * Copyright (c) 2003-2011 - Gustavo Niemeyer <gustavo@niemeyer.net>
 * Copyright (c) 2012 - Tomi Pievil√§inen <tomi.pievilainen@iki.fi>
 * https://github.com/jkbrzt/rrule/blob/master/LICENCE
 *
 */
/* global module, define */

!function(e,t){"object"==typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):(e.RRule=t(e),e.RRuleSet=e.RRule.RRuleSet,e.rrulestr=e.RRule.rrulestr)}("object"==typeof window?window:this,function(e){function t(){if(!t._nlp)if(e&&e._getRRuleNLP)t._nlp=e._getRRuleNLP(Y);else{if("function"!=typeof require)throw new Error("You need to include rrule/nlp.js for fromText/toText to work.");t._nlp=require("./nlp")(Y)}return t._nlp}var n={MONTH_DAYS:[31,28,31,30,31,30,31,31,30,31,30,31],ONE_DAY:864e5,MAXYEAR:9999,ORDINAL_BASE:new Date(1970,0,1),PY_WEEKDAYS:[6,0,1,2,3,4,5],getYearDay:function(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate());return Math.ceil((t-new Date(e.getFullYear(),0,1))/n.ONE_DAY)+1},isLeapYear:function(e){return e instanceof Date&&(e=e.getFullYear()),e%4==0&&e%100!=0||e%400==0},tzOffset:function(e){return 60*e.getTimezoneOffset()*1e3},daysBetween:function(e,t){var r=e.getTime()-n.tzOffset(e),i=t.getTime()-n.tzOffset(t),a=Math.abs(r-i);return Math.round(a/n.ONE_DAY)},toOrdinal:function(e){return n.daysBetween(e,n.ORDINAL_BASE)},fromOrdinal:function(e){var t=e*n.ONE_DAY;return new Date(n.ORDINAL_BASE.getTime()-n.tzOffset(n.ORDINAL_BASE)+t+n.tzOffset(new Date(t)))},monthRange:function(e,t){var r=new Date(e,t,1);return[n.getWeekday(r),n.getMonthDays(r)]},getMonthDays:function(e){var t=e.getMonth();return 1===t&&n.isLeapYear(e)?29:n.MONTH_DAYS[t]},getWeekday:function(e){return n.PY_WEEKDAYS[e.getDay()]},combine:function(e,t){return t=t||e,new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds())},clone:function(e){return new Date(e.getTime())},cloneDates:function(e){for(var t=[],r=0;r<e.length;r++)t.push(n.clone(e[r]));return t},sort:function(e){e.sort(function(e,t){return e.getTime()-t.getTime()})},timeToUntilString:function(e){for(var t,n=new Date(e),r=[n.getUTCFullYear(),n.getUTCMonth()+1,n.getUTCDate(),"T",n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds(),"Z"],i=0;i<r.length;i++)t=r[i],!/[TZ]/.test(t)&&t<10&&(r[i]="0"+String(t));return r.join("")},untilStringToDate:function(e){var t=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z)?$/.exec(e);if(!t)throw new Error("Invalid UNTIL value: "+e);return new Date(Date.UTC(t[1],t[2]-1,t[3],t[5]||0,t[6]||0,t[7]||0))}};n.Time=function(e,t,n,r){this.hour=e,this.minute=t,this.second=n,this.millisecond=r||0},n.Time.prototype={constructor:n.Time,getHours:function(){return this.hour},getMinutes:function(){return this.minute},getSeconds:function(){return this.second},getMilliseconds:function(){return this.millisecond},getTime:function(){return 1e3*(60*this.hour*60+60*this.minute+this.second)+this.millisecond}};var r=function(e,t){1===arguments.length&&(t=e,e=0);for(var n=[],r=e;r<t;r++)n.push(r);return n},i=function(e,t){var n=0,r=[];if(e instanceof Array)for(;n<t;n++)r[n]=[].concat(e);else for(;n<t;n++)r[n]=e;return r},a=function(e,t,n){var r=e.split(t);return n?r.slice(0,n).concat([r.slice(n).join(t)]):r},o=function(e,t){var n=e%t;return n*t<0?n+t:n},s=function(e,t){return{div:Math.floor(e/t),mod:o(e,t)}},l=function(e){return!(e instanceof Array&&0===e.length)&&Boolean(e)},h=function(e,t){return-1!==e.indexOf(t)},u=[].concat(i(1,31),i(2,28),i(3,31),i(4,30),i(5,31),i(6,30),i(7,31),i(8,31),i(9,30),i(10,31),i(11,30),i(12,31),i(1,7)),f=[].concat(i(1,31),i(2,29),i(3,31),i(4,30),i(5,31),i(6,30),i(7,31),i(8,31),i(9,30),i(10,31),i(11,30),i(12,31),i(1,7)),c=r(1,29),y=r(1,30),d=r(1,31),p=r(1,32),w=[].concat(p,y,p,d,p,d,p,p,d,p,d,p,p.slice(0,7)),m=[].concat(p,c,p,d,p,d,p,p,d,p,d,p,p.slice(0,7));c=r(-28,0),y=r(-29,0),d=r(-30,0),p=r(-31,0);var b=[].concat(p,y,p,d,p,d,p,p,d,p,d,p,p.slice(0,7)),g=[].concat(p,c,p,d,p,d,p,p,d,p,d,p,p.slice(0,7)),_=[0,31,60,91,121,152,182,213,244,274,305,335,366],E=[0,31,59,90,120,151,181,212,243,273,304,334,365],k=function(){for(var e=[],t=0;t<55;t++)e=e.concat(r(7));return e}(),T=function(e,t){if(0===t)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t};T.prototype={constructor:T,nth:function(e){return this.n===e?this:new T(this.weekday,e)},equals:function(e){return this.weekday===e.weekday&&this.n===e.n},toString:function(){var e=["MO","TU","WE","TH","FR","SA","SU"][this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},getJsWeekday:function(){return 6===this.weekday?0:this.weekday+1}};var Y=function(e,t){e=e||{},this._string=null,this._cache=t?null:{all:!1,before:[],after:[],between:[]},this.origOptions={};var r=[],i=Object.keys(e),a=Object.keys(Y.DEFAULT_OPTIONS);if(i.forEach(function(t){this.origOptions[t]=e[t],h(a,t)||r.push(t)},this),r.length)throw new Error("Invalid options: "+r.join(", "));if(!Y.FREQUENCIES[e.freq]&&null===e.byeaster)throw new Error("Invalid frequency: "+String(e.freq));a.forEach(function(t){h(i,t)||(e[t]=Y.DEFAULT_OPTIONS[t])});var o=this.options=e;null!==o.byeaster&&(o.freq=Y.YEARLY),o.dtstart||(o.dtstart=new Date);var s=o.dtstart.getTime()%1e3;if(null===o.wkst?o.wkst=Y.MO.weekday:"number"==typeof o.wkst||(o.wkst=o.wkst.weekday),null!==o.bysetpos){"number"==typeof o.bysetpos&&(o.bysetpos=[o.bysetpos]);for(var u=0;u<o.bysetpos.length;u++){var f=o.bysetpos[u];if(0===f||!(f>=-366&&f<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(l(o.byweekno)||l(o.byyearday)||l(o.bymonthday)||null!==o.byweekday||null!==o.byeaster))switch(o.freq){case Y.YEARLY:o.bymonth||(o.bymonth=o.dtstart.getMonth()+1),o.bymonthday=o.dtstart.getDate();break;case Y.MONTHLY:o.bymonthday=o.dtstart.getDate();break;case Y.WEEKLY:o.byweekday=n.getWeekday(o.dtstart)}if(null===o.bymonth||o.bymonth instanceof Array||(o.bymonth=[o.bymonth]),null===o.byyearday||o.byyearday instanceof Array||(o.byyearday=[o.byyearday]),null===o.bymonthday)o.bymonthday=[],o.bynmonthday=[];else if(o.bymonthday instanceof Array){var c=[],y=[];for(u=0;u<o.bymonthday.length;u++)(f=o.bymonthday[u])>0?c.push(f):f<0&&y.push(f);o.bymonthday=c,o.bynmonthday=y}else o.bymonthday<0?(o.bynmonthday=[o.bymonthday],o.bymonthday=[]):(o.bynmonthday=[],o.bymonthday=[o.bymonthday]);if(null===o.byweekno||o.byweekno instanceof Array||(o.byweekno=[o.byweekno]),null===o.byweekday)o.bynweekday=null;else if("number"==typeof o.byweekday)o.byweekday=[o.byweekday],o.bynweekday=null;else if(o.byweekday instanceof T)!o.byweekday.n||o.freq>Y.MONTHLY?(o.byweekday=[o.byweekday.weekday],o.bynweekday=null):(o.bynweekday=[[o.byweekday.weekday,o.byweekday.n]],o.byweekday=null);else{var d=[],p=[];for(u=0;u<o.byweekday.length;u++){var w=o.byweekday[u];"number"==typeof w?d.push(w):!w.n||o.freq>Y.MONTHLY?d.push(w.weekday):p.push([w.weekday,w.n])}o.byweekday=l(d)?d:null,o.bynweekday=l(p)?p:null}if(null===o.byhour?o.byhour=o.freq<Y.HOURLY?[o.dtstart.getHours()]:null:"number"==typeof o.byhour&&(o.byhour=[o.byhour]),null===o.byminute?o.byminute=o.freq<Y.MINUTELY?[o.dtstart.getMinutes()]:null:"number"==typeof o.byminute&&(o.byminute=[o.byminute]),null===o.bysecond?o.bysecond=o.freq<Y.SECONDLY?[o.dtstart.getSeconds()]:null:"number"==typeof o.bysecond&&(o.bysecond=[o.bysecond]),o.freq>=Y.HOURLY)this.timeset=null;else{for(this.timeset=[],u=0;u<o.byhour.length;u++)for(var m=o.byhour[u],b=0;b<o.byminute.length;b++)for(var g=o.byminute[b],_=0;_<o.bysecond.length;_++){var E=o.bysecond[_];this.timeset.push(new n.Time(m,g,E,s))}n.sort(this.timeset)}};Y.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],Y.YEARLY=0,Y.MONTHLY=1,Y.WEEKLY=2,Y.DAILY=3,Y.HOURLY=4,Y.MINUTELY=5,Y.SECONDLY=6,Y.MO=new T(0),Y.TU=new T(1),Y.WE=new T(2),Y.TH=new T(3),Y.FR=new T(4),Y.SA=new T(5),Y.SU=new T(6),Y.DEFAULT_OPTIONS={freq:null,dtstart:null,interval:1,wkst:Y.MO,count:null,until:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},Y.parseText=function(e,n){return t().parseText(e,n)},Y.fromText=function(e,n){return t().fromText(e,n)},Y.optionsToString=function(e){for(var t,r,i,a=[],o=Object.keys(e),s=Object.keys(Y.DEFAULT_OPTIONS),l=0;l<o.length;l++)if(h(s,o[l])&&(t=o[l].toUpperCase(),r=e[o[l]],i=[],!(null===r||r instanceof Array&&!r.length))){switch(t){case"FREQ":r=Y.FREQUENCIES[e.freq];break;case"WKST":r=r.toString();break;case"BYWEEKDAY":t="BYDAY",r instanceof Array||(r=[r]);for(var u,f=0;f<r.length;f++)(u=r[f])instanceof T||(u=u instanceof Array?new T(u[0],u[1]):new T(u)),i[f]=u.toString();r=i;break;case"DTSTART":case"UNTIL":r=n.timeToUntilString(r);break;default:if(r instanceof Array){for(f=0;f<r.length;f++)i[f]=String(r[f]);r=i}else r=String(r)}a.push([t,r])}var c=[];for(l=0;l<a.length;l++){var y=a[l];c.push(y[0]+"="+y[1].toString())}return c.join(";")},Y.prototype={constructor:Y,all:function(e){if(e)return this._iter(new R("all",{},e));var t=this._cacheGet("all");return!1===t&&(t=this._iter(new v("all",{})),this._cacheAdd("all",t)),t},between:function(e,t,n,r){var i={before:t,after:e,inc:n};if(r)return this._iter(new R("between",i,r));var a=this._cacheGet("between",i);return!1===a&&(a=this._iter(new v("between",i)),this._cacheAdd("between",a,i)),a},before:function(e,t){var n={dt:e,inc:t},r=this._cacheGet("before",n);return!1===r&&(r=this._iter(new v("before",n)),this._cacheAdd("before",r,n)),r},after:function(e,t){var n={dt:e,inc:t},r=this._cacheGet("after",n);return!1===r&&(r=this._iter(new v("after",n)),this._cacheAdd("after",r,n)),r},count:function(){return this.all().length},toString:function(){return Y.optionsToString(this.origOptions)},toText:function(e,n){return t().toText(this,e,n)},isFullyConvertibleToText:function(){return t().isFullyConvertible(this)},_cacheAdd:function(e,t,r){this._cache&&(t&&(t=t instanceof Date?n.clone(t):n.cloneDates(t)),"all"===e?this._cache.all=t:(r._value=t,this._cache[e].push(r)))},_cacheGet:function(e,t){if(!this._cache)return!1;var r=!1,i=t?Object.keys(t):[];if("all"===e)r=this._cache.all;else for(var a,o=0;o<this._cache[e].length;o++)if(a=this._cache[e][o],!i.length||!function(e){for(var n,r=0;r<i.length;r++)if(n=i[r],String(t[n])!==String(e[n]))return!0;return!1}(a)){r=a._value;break}if(!r&&this._cache.all){var s=new v(e,t);for(o=0;o<this._cache.all.length&&s.accept(this._cache.all[o]);o++);r=s.getValue(),this._cacheAdd(e,r,t)}return r instanceof Array?n.cloneDates(r):r instanceof Date?n.clone(r):r},clone:function(){return new Y(this.origOptions)},_iter:function(e){var t=this.options.dtstart,r=this.options.dtstart%1e3,i=t.getFullYear(),a=t.getMonth()+1,u=t.getDate(),f=t.getHours(),c=t.getMinutes(),y=t.getSeconds(),d=n.getWeekday(t),p=this.options.freq,w=this.options.interval,m=this.options.wkst,b=this.options.until,g=this.options.bymonth,_=this.options.byweekno,E=this.options.byyearday,k=this.options.byweekday,T=this.options.byeaster,v=this.options.bymonthday,R=this.options.bynmonthday,O=this.options.bysetpos,L=this.options.byhour,A=this.options.byminute,S=this.options.bysecond,N=new D(this);N.rebuild(i,a);var M={};M[Y.YEARLY]=N.ydayset,M[Y.MONTHLY]=N.mdayset,M[Y.WEEKLY]=N.wdayset,M[Y.DAILY]=N.ddayset,M[Y.HOURLY]=N.ddayset,M[Y.MINUTELY]=N.ddayset,M[Y.SECONDLY]=N.ddayset,M=M[p];var U;if(p<Y.HOURLY)U=this.timeset;else{var x={};x[Y.HOURLY]=N.htimeset,x[Y.MINUTELY]=N.mtimeset,x[Y.SECONDLY]=N.stimeset,x=x[p],U=p>=Y.HOURLY&&l(L)&&!h(L,f)||p>=Y.MINUTELY&&l(A)&&!h(A,c)||p>=Y.SECONDLY&&l(S)&&!h(S,c)?[]:x.call(N,f,c,y,r)}for(var I,H,C,z,B,W,F,q,j,K,V,P,X,G=0,Q=this.options.count;;){for(j=(F=M.call(N,i,a,u))[0],K=F[1],V=F[2],X=!1,H=K;H<V;H++)I=j[H],(X=l(g)&&!h(g,N.mmask[I])||l(_)&&!N.wnomask[I]||l(k)&&!h(k,N.wdaymask[I])||l(N.nwdaymask)&&!N.nwdaymask[I]||null!==T&&!h(N.eastermask,I)||(l(v)||l(R))&&!h(v,N.mdaymask[I])&&!h(R,N.nmdaymask[I])||l(E)&&(I<N.yearlen&&!h(E,I+1)&&!h(E,-N.yearlen+I)||I>=N.yearlen&&!h(E,I+1-N.yearlen)&&!h(E,-N.nextyearlen+I-N.yearlen)))&&(j[I]=null);if(l(O)&&l(U)){var $,Z,J=[];for(H=0;H<O.length;H++){(q=O[H])<0?($=Math.floor(q/U.length),Z=o(q,U.length)):($=Math.floor((q-1)/U.length),Z=o(q-1,U.length));try{for(F=[],C=K;C<V;C++){var ee=j[C];null!==ee&&F.push(ee)}I=$<0?F.slice($)[0]:F[$];var te=U[Z],ne=n.fromOrdinal(N.yearordinal+I),re=n.combine(ne,te);h(J,re)||J.push(re)}catch(e){}}for(n.sort(J),H=0;H<J.length;H++){if(re=J[H],b&&re>b)return this._len=G,e.getValue();if(re>=t){if(++G,!e.accept(re))return e.getValue();if(Q&&!--Q)return this._len=G,e.getValue()}}}else for(H=K;H<V;H++)if(null!==(I=j[H]))for(ne=n.fromOrdinal(N.yearordinal+I),C=0;C<U.length;C++){if(te=U[C],re=n.combine(ne,te),b&&re>b)return this._len=G,e.getValue();if(re>=t){if(++G,!e.accept(re))return e.getValue();if(Q&&!--Q)return this._len=G,e.getValue()}}if(P=!1,p===Y.YEARLY){if((i+=w)>n.MAXYEAR)return this._len=G,e.getValue();N.rebuild(i,a)}else if(p===Y.MONTHLY){if((a+=w)>12&&(B=Math.floor(a/12),W=o(a,12),a=W,i+=B,0===a&&(a=12,--i),i>n.MAXYEAR))return this._len=G,e.getValue();N.rebuild(i,a)}else if(p===Y.WEEKLY)u+=m>d?7*w-(d+1+(6-m)):7*w-(d-m),d=m,P=!0;else if(p===Y.DAILY)u+=w,P=!0;else if(p===Y.HOURLY){for(X&&(f+=Math.floor((23-f)/w)*w);;)if(f+=w,z=s(f,24),B=z.div,W=z.mod,B&&(f=W,u+=B,P=!0),!l(L)||h(L,f))break;U=x.call(N,f,c,y)}else if(p===Y.MINUTELY){for(X&&(c+=Math.floor((1439-(60*f+c))/w)*w);;)if(c+=w,z=s(c,60),B=z.div,W=z.mod,B&&(c=W,B=(z=s(f+=B,24)).div,W=z.mod,B&&(f=W,u+=B,P=!0,X=!1)),(!l(L)||h(L,f))&&(!l(A)||h(A,c)))break;U=x.call(N,f,c,y)}else if(p===Y.SECONDLY){for(X&&(y+=Math.floor((86399-(3600*f+60*c+y))/w)*w);;)if(y+=w,z=s(y,60),B=z.div,W=z.mod,B&&(y=W,B=(z=s(c+=B,60)).div,W=z.mod,B&&(c=W,B=(z=s(f+=B,24)).div,W=z.mod,B&&(f=W,u+=B,P=!0))),(!l(L)||h(L,f))&&(!l(A)||h(A,c))&&(!l(S)||h(S,y)))break;U=x.call(N,f,c,y)}if(P&&u>28){var ie=n.monthRange(i,a-1)[1];if(u>ie){for(;u>ie;){if(u-=ie,13===++a&&(a=1,++i>n.MAXYEAR))return this._len=G,e.getValue();ie=n.monthRange(i,a-1)[1]}N.rebuild(i,a)}}}}},Y.parseString=function(e){if(!(e=e.replace(/^\s+|\s+$/,"")).length)return null;var t,r,i,a,o,s=e.split(";"),l={};for(t=0;t<s.length;t++)switch(o=s[t].split("="),i=o[0],a=o[1],i){case"FREQ":l.freq=Y[a];break;case"WKST":l.wkst=Y[a];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":if(-1!==a.indexOf(","))for(a=a.split(","),r=0;r<a.length;r++)/^[+-]?\d+$/.test(a[r])&&(a[r]=Number(a[r]));else/^[+-]?\d+$/.test(a)&&(a=Number(a));l[i=i.toLowerCase()]=a;break;case"BYDAY":var h,u,f,c=a.split(",");for(l.byweekday=[],r=0;r<c.length;r++)2===(f=c[r]).length?(u=Y[f],l.byweekday.push(u)):(f=f.match(/^([+-]?\d)([A-Z]{2})$/),h=Number(f[1]),u=f[2],u=Y[u].weekday,l.byweekday.push(new T(u,h)));break;case"DTSTART":l.dtstart=n.untilStringToDate(a);break;case"UNTIL":l.until=n.untilStringToDate(a);break;case"BYEASTER":l.byeaster=Number(a);break;default:throw new Error("Unknown RRULE property '"+i+"'")}return l},Y.fromString=function(e){return new Y(Y.parseString(e))};var D=function(e){this.rrule=e,this.lastyear=null,this.lastmonth=null,this.yearlen=null,this.nextyearlen=null,this.yearordinal=null,this.yearweekday=null,this.mmask=null,this.mrange=null,this.mdaymask=null,this.nmdaymask=null,this.wdaymask=null,this.wnomask=null,this.nwdaymask=null,this.eastermask=null};D.prototype.easter=function(e,t){t=t||0;var n=e%19,r=Math.floor(e/100),i=e%100,a=Math.floor(r/4),o=r%4,s=Math.floor((r+8)/25),l=Math.floor((r-s+1)/3),h=Math.floor(19*n+r-a-l+15)%30,u=Math.floor(i/4),f=i%4,c=Math.floor(32+2*o+2*u-h-f)%7,y=Math.floor((n+11*h+22*c)/451),d=Math.floor((h+c-7*y+114)/31),p=(h+c-7*y+114)%31+1,w=Date.UTC(e,d-1,p+t),m=Date.UTC(e,0,1);return[Math.ceil((w-m)/864e5)]},D.prototype.rebuild=function(e,t){var r=this.rrule;if(e!==this.lastyear){this.yearlen=n.isLeapYear(e)?366:365,this.nextyearlen=n.isLeapYear(e+1)?366:365;var a=new Date(e,0,1);this.yearordinal=n.toOrdinal(a),this.yearweekday=n.getWeekday(a);var s=n.getWeekday(new Date(e,0,1));if(365===this.yearlen?(this.mmask=[].concat(u),this.mdaymask=[].concat(m),this.nmdaymask=[].concat(g),this.wdaymask=k.slice(s),this.mrange=[].concat(E)):(this.mmask=[].concat(f),this.mdaymask=[].concat(w),this.nmdaymask=[].concat(b),this.wdaymask=k.slice(s),this.mrange=[].concat(_)),l(r.options.byweekno)){this.wnomask=i(0,this.yearlen+7);var c,y,d;(c=y=o(7-this.yearweekday+r.options.wkst,7))>=4?(c=0,d=this.yearlen+o(this.yearweekday-r.options.wkst,7)):d=this.yearlen-c;for(var p,T,D=Math.floor(d/7),v=o(d,7),R=Math.floor(D+v/4),O=0;O<r.options.byweekno.length;O++)if((p=r.options.byweekno[O])<0&&(p+=R+1),p>0&&p<=R){p>1?(T=c+7*(p-1),c!==y&&(T-=7-y)):T=c;for(var L=0;L<7&&(this.wnomask[T]=1,T++,this.wdaymask[T]!==r.options.wkst);L++);}if(h(r.options.byweekno,1)&&(T=c+7*R,c!==y&&(T-=7-y),T<this.yearlen))for(O=0;O<7&&(this.wnomask[T]=1,T+=1,this.wdaymask[T]!==r.options.wkst);O++);if(c){var A;if(h(r.options.byweekno,-1))A=-1;else{var S=n.getWeekday(new Date(e-1,0,1)),N=o(7-S+r.options.wkst,7),M=n.isLeapYear(e-1)?366:365;N>=4?(N=0,A=Math.floor(52+o(M+o(S-r.options.wkst,7),7)/4)):A=Math.floor(52+o(this.yearlen-c,7)/4)}if(h(r.options.byweekno,A))for(T=0;T<c;T++)this.wnomask[T]=1}}else this.wnomask=null}if(l(r.options.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var U=[];if(r.options.freq===Y.YEARLY)if(l(r.options.bymonth))for(O=0;O<r.options.bymonth.length;O++)t=r.options.bymonth[O],U.push(this.mrange.slice(t-1,t+1));else U=[[0,this.yearlen]];else r.options.freq===Y.MONTHLY&&(U=[this.mrange.slice(t-1,t+1)]);if(l(U))for(this.nwdaymask=i(0,this.yearlen),O=0;O<U.length;O++){var x=U[O],I=x[0],H=x[1];for(H-=1,L=0;L<r.options.bynweekday.length;L++)s=r.options.bynweekday[L][0],(p=r.options.bynweekday[L][1])<0?(T=H+7*(p+1),T-=o(this.wdaymask[T]-s,7)):(T=I+7*(p-1),T+=o(7-this.wdaymask[T]+s,7)),I<=T&&T<=H&&(this.nwdaymask[T]=1)}this.lastyear=e,this.lastmonth=t}null!==r.options.byeaster&&(this.eastermask=this.easter(e,r.options.byeaster))},D.prototype.ydayset=function(e,t,n){return[r(this.yearlen),0,this.yearlen]},D.prototype.mdayset=function(e,t,n){for(var r=i(null,this.yearlen),a=this.mrange[t-1],o=this.mrange[t],s=a;s<o;s++)r[s]=s;return[r,a,o]},D.prototype.wdayset=function(e,t,r){for(var a=i(null,this.yearlen+7),o=n.toOrdinal(new Date(e,t-1,r))-this.yearordinal,s=o,l=0;l<7&&(a[o]=o,++o,this.wdaymask[o]!==this.rrule.options.wkst);l++);return[a,s,o]},D.prototype.ddayset=function(e,t,r){var a=i(null,this.yearlen),o=n.toOrdinal(new Date(e,t-1,r))-this.yearordinal;return a[o]=o,[a,o,o+1]},D.prototype.htimeset=function(e,t,r,i){for(var a=[],o=this.rrule,s=0;s<o.options.byminute.length;s++){t=o.options.byminute[s];for(var l=0;l<o.options.bysecond.length;l++)r=o.options.bysecond[l],a.push(new n.Time(e,t,r,i))}return n.sort(a),a},D.prototype.mtimeset=function(e,t,r,i){for(var a=[],o=this.rrule,s=0;s<o.options.bysecond.length;s++)r=o.options.bysecond[s],a.push(new n.Time(e,t,r,i));return n.sort(a),a},D.prototype.stimeset=function(e,t,r,i){return[new n.Time(e,t,r,i)]};var v=function(e,t){this.init(e,t)};v.prototype={constructor:v,init:function(e,t){this.method=e,this.args=t,this.minDate=null,this.maxDate=null,this._result=[],"between"===e?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):"before"===e?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):"after"===e&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))},accept:function(e){var t=this.minDate&&e<this.minDate,n=this.maxDate&&e>this.maxDate;if("between"===this.method){if(t)return!0;if(n)return!1}else if("before"===this.method){if(n)return!1}else if("after"===this.method)return!!t||(this.add(e),!1);return this.add(e)},add:function(e){return this._result.push(e),!0},getValue:function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":return e.length?e[e.length-1]:null}},clone:function(){return new v(this.method,this.args)}};var R=function(e,t,n){if(!h(["all","between"],e))throw new Error('Invalid method "'+e+'". Only all and between works with iterator.');this.add=function(e){return!!n(e,this._result.length)&&(this._result.push(e),!0)},this.init(e,t)};R.prototype=v.prototype;var O=function(e){this._cache=e?null:{all:!1,before:[],after:[],between:[]},this._rrule=[],this._rdate=[],this._exrule=[],this._exdate=[]};O.prototype={constructor:O,rrule:function(e){if(!(e instanceof Y))throw new TypeError(String(e)+" is not RRule instance");h(this._rrule.map(String),String(e))||this._rrule.push(e)},rdate:function(e){if(!(e instanceof Date))throw new TypeError(String(e)+" is not Date instance");h(this._rdate.map(Number),Number(e))||(this._rdate.push(e),n.sort(this._rdate))},exrule:function(e){if(!(e instanceof Y))throw new TypeError(String(e)+" is not RRule instance");h(this._exrule.map(String),String(e))||this._exrule.push(e)},exdate:function(e){if(!(e instanceof Date))throw new TypeError(String(e)+" is not Date instance");h(this._exdate.map(Number),Number(e))||(this._exdate.push(e),n.sort(this._exdate))},valueOf:function(){var e=[];return this._rrule.length&&this._rrule.forEach(function(t){e.push("RRULE:"+t)}),this._rdate.length&&e.push("RDATE:"+this._rdate.map(function(e){return n.timeToUntilString(e)}).join(",")),this._exrule.length&&this._exrule.forEach(function(t){e.push("EXRULE:"+t)}),this._exdate.length&&e.push("EXDATE:"+this._exdate.map(function(e){return n.timeToUntilString(e)}).join(",")),e},toString:function(){return JSON.stringify(this.valueOf())},_iter:function(e){function t(e,t){i.forEach(function(n){n.between(e,t,!0).forEach(function(e){r[Number(e)]=!0})})}var r={},i=this._exrule,a=e.accept;this._exdate.forEach(function(e){r[Number(e)]=!0}),e.accept=function(e){var n=Number(e);return!(!r[n]&&(t(new Date(n-1),new Date(n+1)),!r[n]))||(r[n]=!0,a.call(this,e))},"between"===e.method&&(t(e.args.after,e.args.before),e.accept=function(e){var t=Number(e);return!!r[t]||(r[t]=!0,a.call(this,e))});for(var o=0;o<this._rdate.length&&e.accept(new Date(this._rdate[o]));o++);this._rrule.forEach(function(t){t._iter(e)});var s=e._result;switch(n.sort(s),e.method){case"all":case"between":return s;case"before":return s.length&&s[s.length-1]||null;case"after":return s.length&&s[0]||null;default:return null}},clone:function(){var e,t=new O(!!this._cache);for(e=0;e<this._rrule.length;e++)t.rrule(this._rrule[e].clone());for(e=0;e<this._rdate.length;e++)t.rdate(new Date(this._rdate[e]));for(e=0;e<this._exrule.length;e++)t.exrule(this._exrule[e].clone());for(e=0;e<this._exdate.length;e++)t.exdate(new Date(this._exdate[e]));return t}},["all","between","before","after","count","_cacheAdd","_cacheGet"].forEach(function(e){O.prototype[e]=Y.prototype[e]});var L=function(){};L.DEFAULT_OPTIONS={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,ignoretz:!1,tzinfos:null},L._freq_map={YEARLY:Y.YEARLY,MONTHLY:Y.MONTHLY,WEEKLY:Y.WEEKLY,DAILY:Y.DAILY,HOURLY:Y.HOURLY,MINUTELY:Y.MINUTELY,SECONDLY:Y.SECONDLY},L._weekday_map={MO:0,TU:1,WE:2,TH:3,FR:4,SA:5,SU:6},(L.prototype={constructor:L,_handle_int:function(e,t,n,r){e[t.toLowerCase()]=parseInt(n,10)},_handle_int_list:function(e,t,n,r){e[t.toLowerCase()]=n.split(",").map(function(e){return parseInt(e,10)})},_handle_FREQ:function(e,t,n,r){e.freq=L._freq_map[n]},_handle_UNTIL:function(e,t,r,i){try{e.until=n.untilStringToDate(r)}catch(e){throw new Error("invalid until date")}},_handle_WKST:function(e,t,n,r){e.wkst=L._weekday_map[n]},_handle_BYWEEKDAY:function(e,t,n,r){var i,a,o,s,l,h,u=[],f=n.split(",");for(a=0;a<f.length;a++){if((h=f[a]).indexOf("(")>-1)l=(i=h.split("("))[0],s=parseInt(i.slice(1,-1),10);else{for(o=0;o<h.length&&-1!=="+-0123456789".indexOf(h[o]);o++);s=h.slice(0,o)||null,l=h.slice(o),s&&(s=parseInt(s,10))}var c=new T(L._weekday_map[l],s);u.push(c)}e.byweekday=u},_parseRfcRRule:function(e,t){(t=t||{}).dtstart=t.dtstart||null,t.cache=t.cache||!1,t.ignoretz=t.ignoretz||!1,t.tzinfos=t.tzinfos||null;var n,r,i;if(-1!==e.indexOf(":")){if(i=e.split(":"),n=i[0],r=i[1],"RRULE"!==n)throw new Error("unknown parameter name")}else r=e;var a,o={},s=r.split(";");for(a=0;a<s.length;a++){i=s[a].split("="),n=i[0].toUpperCase(),r=i[1].toUpperCase();try{this["_handle_"+n](o,n,r,{ignoretz:t.ignoretz,tzinfos:t.tzinfos})}catch(e){throw new Error("unknown parameter '"+n+"':"+r)}}return o.dtstart=o.dtstart||t.dtstart,new Y(o,!t.cache)},_parseRfc:function(e,t){if(t.compatible&&(t.forceset=!0,t.unfold=!0),!(e=e&&e.toUpperCase().trim()))throw new Error("Invalid empty string");var r,i,o=0;if(t.unfold)for(i=e.split("\n");o<i.length;)(r=i[o]=i[o].replace(/\s+$/g,""))?o>0&&" "===r[0]?(i[o-1]+=r.slice(1),i.splice(o,1)):o+=1:i.splice(o,1);else i=e.split(/\s/);var s,l,h,u,f,c,y,d,p,w,m,b=[],g=[],_=[],E=[];if(t.forceset||1!==i.length||-1!==e.indexOf(":")&&0!==e.indexOf("RRULE:")){for(o=0;o<i.length;o++)if(r=i[o]){if(-1===r.indexOf(":")?(s="RRULE",l=r):(s=(h=a(r,":",1))[0],l=h[1]),!(u=s.split(";")))throw new Error("empty property name");if(s=u[0],u=u.slice(1),"RRULE"===s){for(d=0;d<u.length;d++)throw f=u[d],new Error("unsupported RRULE parm: "+f);b.push(l)}else if("RDATE"===s){for(d=0;d<u.length;d++)if("VALUE=DATE-TIME"!==(f=u[d]))throw new Error("unsupported RDATE parm: "+f);g.push(l)}else if("EXRULE"===s){for(d=0;d<u.length;d++)throw f=u[d],new Error("unsupported EXRULE parm: "+f);_.push(l)}else if("EXDATE"===s){for(d=0;d<u.length;d++)if("VALUE=DATE-TIME"!==(f=u[d]))throw new Error("unsupported RDATE parm: "+f);E.push(l)}else{if("DTSTART"!==s)throw new Error("unsupported property: "+s);c=n.untilStringToDate(l)}}if(t.forceset||b.length>1||g.length||_.length||E.length){for(y=new O(!t.cache),d=0;d<b.length;d++)y.rrule(this._parseRfcRRule(b[d],{dtstart:t.dtstart||c,ignoretz:t.ignoretz,tzinfos:t.tzinfos}));for(d=0;d<g.length;d++)for(w=g[d].split(","),p=0;p<w.length;p++)m=w[p],y.rdate(n.untilStringToDate(m));for(d=0;d<_.length;d++)y.exrule(this._parseRfcRRule(_[d],{dtstart:t.dtstart||c,ignoretz:t.ignoretz,tzinfos:t.tzinfos}));for(d=0;d<E.length;d++)for(w=E[d].split(","),p=0;p<w.length;p++)m=w[p],y.exdate(n.untilStringToDate(m));return t.campatiable&&t.dtstart&&y.rdate(c),y}return this._parseRfcRRule(b[0],{dtstart:t.dtstart||c,cache:t.cache,ignoretz:t.ignoretz,tzinfos:t.tzinfos})}return this._parseRfcRRule(i[0],{cache:t.cache,dtstart:t.dtstart,ignoretz:t.ignoretz,tzinfos:t.tzinfos})},parse:function(e,t){t=t||{};var n=[],r=Object.keys(t),i=Object.keys(L.DEFAULT_OPTIONS);if(r.forEach(function(e){h(i,e)||n.push(e)},this),n.length)throw new Error("Invalid options: "+n.join(", "));return i.forEach(function(e){h(r,e)||(t[e]=L.DEFAULT_OPTIONS[e])}),this._parseRfc(e,t)}})._handle_DTSTART=function(e,t,r,i){e[t.toLowerCase()]=n.untilStringToDate(r)},L.prototype._handle_BYDAY=L.prototype._handle_BYWEEKDAY,L.prototype._handle_INTERVAL=L.prototype._handle_int,L.prototype._handle_COUNT=L.prototype._handle_int,["_handle_BYSETPOS","_handle_BYMONTH","_handle_BYMONTHDAY","_handle_BYYEARDAY","_handle_BYEASTER","_handle_BYWEEKNO","_handle_BYHOUR","_handle_BYMINUTE","_handle_BYSECOND"].forEach(function(e){L.prototype[e]=L.prototype._handle_int_list});var A=new L,S=function(){return A.parse.apply(A,arguments)};return Y.RRule=Y,Y.RRuleSet=O,Y.rrulestr=S,Y});
